#!/bin/bash

SSID=$1

if [[ -z $SSID ]]; then
    echo Usage: $0 SSID
    exit 1
fi

IW_DIR=$(mktemp -d)
IW=$IW_DIR/iw
mkfifo "$IW"

iw event >"$IW" &
IW_PID=$!

finish() {
    kill -PIPE "$IW_PID"
    wait -n "$IW_PID"

    rm -r "$IW_DIR"
    exit
}

trap finish EXIT TERM INT

while :; do
    wait-beacon "$SSID" || continue

    timeout 20 wait-line "$IW" "new station" &
    WAIT_PID=$!

    join-adhoc "$SSID" || continue
    wait -n "$WAIT_PID" || continue

    wait-disconnect
done
